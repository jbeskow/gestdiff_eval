<!DOCTYPE html>
<html>

<head>
    <title>Rate synthesised audios</title>
    <script src="https://unpkg.com/jspsych@7.2.3"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.0.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-button-response@1.0.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey-html-form@1.0.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-browser-check@1.0.1"></script>
    <script src="jspsych-new-mushra.js"></script>
    <script src="utilities.js"></script>
    <link href="https://unpkg.com/jspsych@7.2.3/css/jspsych.css" rel="stylesheet" type="text/css" />

    <!-- jsPsychSheet library -->
    <script src="jspsychsheet.js"></script>
    <link rel="stylesheet" href="jspsychsheet.css" />

    <!-- jQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

</head>

<body></body>
<script>

    var data_submit_url = "https://script.google.com/macros/s/AKfycbyuMGZ8xgB9cWLUPyurL0iyb4QtC9F50CTxsf6TalU3NnnlmweRksCc-MpRwmOQUAJ0/exec";
    // var data_submit_url = "https://lol"

    var success_url = "https://app.prolific.co/submissions/complete?cc=4F73FA73";
    var incompatible_device_url = "https://app.prolific.co/submissions/complete?cc=C1EECYYK";
    var no_concent_url = "https://app.prolific.co/submissions/complete?cc=C1B9QFKV";

    var jsPsych = initJsPsych({
        show_progress_bar: true,
        override_safe_mode: true,
        on_finish: function () {
            url = data_submit_url;
            jsPsychSheet.uploadData(url, jsPsych.data.get().csv())
            window.location.href = success_url;
        }
    })


    function get_trial_block(wavfile, attention_check = false) {
        let audios = []
        for (let system of systems) {
            wav_filename = "ListeningTest/".concat(system, "/", system.concat("_", wavfile, ".wav"))
            audios.push({ audio_name: wav_filename });
        }

        let single_audio_page = {
            type: mushraPlugin,
            preamble: 'Listen to the speech samples and rate how natural they sound to you',
            test_name: wavfile,
            audios: audios,
            attention_check: attention_check,
            randomize_audio_order: true,
            on_finish: function () {
                url = data_submit_url;
                jsPsychSheet.uploadPartialData(url, jsPsych.data.get().csv())
            }
        };
        return single_audio_page;
    }



    /*****************
     *****************
        Configurations
     *****************
    ******************/
    const mos_table = `
    <table class="GeneratedTable">
  <thead>
    <tr>
      <th>Score</th>
      <th>Quality</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>5</td>
      <td>Excellent</td>
    </tr>
    <tr>
      <td>4</td>
      <td>Good</td>
    </tr>
    <tr>
      <td>3</td>
      <td>Fair</td>
    </tr>
    <tr>
      <td>2</td>
      <td>Poor</td>
    </tr>
    <tr>
      <td>1</td>
      <td>Bad</td>
    </tr>
  </tbody>
</table>
    `

    const instructions = `
    <div class="container">
              <div class="jumbotron">
            <ol>
            <li>In this experiment, you will listen to a number of speech samples from an AI voice and <b>rate how natural they sound</b> on a scale from 1 (Bad) to 5 (Excellent).</li>
            ` + mos_table + `
            <li>Each page contains seven different versions of the same spoken sentence. You can listen to the examples in any order and go back and forth as many times as you like. Use this to revise your ratings until you are satisfied. Your responses are anonymous and will be used for academic research on speech synthesis.</li>
            <li>Since the differences between the examples can be quite subtle, please listen carefully and <b> use headphones and a desktop/laptop computer </b> for this test! Also, please do not participate in this experiment if you have a hearing impairment.</li>
            <li>This study includes a number of simple <b> attention checks </b> at random points. A few of the audio samples will instruct you to choose a specific number on the rating scale. This allows us to ensure that participants are paying attention during the experiment.</li>
            </ol>
            <p> <center> This test does not collect any personally identifiable information and please send a message on Prolific if you encounter any issues. </center> </p>
    </div>
</div>
`;

    let systems = [
        "GT",
        "Glow",
        "Tacotron2",
        "OverFlow",
        "OverFlow_NoDropout",
        "OverFlow_NoSample",
        "NH2",
    ];

    /*****************
     *****************
        End Configurations
     *****************
    ******************/

    // Prepare indices for tests
    // let test_sets = [9, 18, 20, 25, 33, 38, 49, 50, 62, 71]

    attn_1 = getRandomArbitrary(8, 12);
    attn_2 = getRandomArbitrary(13, 17);

    indices = randomUnique(41, 16);

    // set2_indices.splice(attn_1, 0, 'Attn_1')
    // set3_indices.splice(attn_2, 0, 'Attn_2')

    // Prepare trials


    let timeline = [];

    for (i = 0; i < indices.length; i++) {
        filename = "".concat(String(indices[i]));
        let attn_check = filename.toLocaleLowerCase().includes('attn');
        timeline.push(get_trial_block(filename, attn_check));
    }

    attn_1_block = get_trial_block('Attn_1', true);
    attn_2_block = get_trial_block('Attn_2', true);



    // for(i = 0; i < stimuli_set.length; i += 1) {
    //     filename = "".concat(String(stimuli_set[i]));
    //     let attn_check = filename.toLocaleLowerCase().includes('attn');
    //     timeline.push(get_trial_block(filename, attn_check));
    // }

    /*****************
     *****************
      Profilic Information 
     *****************
    ******************/

    var subject_id = jsPsych.data.getURLVariable('PROLIFIC_PID');
    var study_id = jsPsych.data.getURLVariable('STUDY_ID');
    var session_id = jsPsych.data.getURLVariable('SESSION_ID');

    jsPsych.data.addProperties({
        subject_id: subject_id,
        study_id: study_id,
        session_id: session_id
    });

    /*****************
     *****************
        End Proflic Information
     *****************
    ******************/


    /*****************
     *****************
        Experiment Design
     *****************
    ******************/


    let end_test = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: `<p>You've completed the test. Thank you for participating!</p>
  <p>Press any key to return to Prolific and complete the study</p>`,
        on_finish: function () {
            url = data_submit_url;
            data = jsPsych.data.get();
            data['trials'][data['trials'].length - 1]['date_time'] = new Date().toLocaleString(); jsPsychSheet.uploadPartialData(url, data.csv())

        }
    };


    let instruction_screen = {
        type: jsPsychHtmlButtonResponse,
        stimulus: instructions,
        choices: ['I agree to participate proceed to the study', 'I do not agree to participate take me back to Prolific'],
        button_html: ['<button class="jspsych-btn agreebutton">%choice%</button>', '<button class="jspsych-btn diagreebutton">%choice%</button>'],
        prompt: "",
        on_finish: function () {
            url = data_submit_url;
            data = jsPsych.data.get();
            data['trials'][data['trials'].length - 1]['date_time'] = new Date().toLocaleString();
            jsPsychSheet.uploadPartialData(url, data.csv())
            if (data['trials'][data['trials'].length - 1]['response'] == 1) {
                window.location.href = no_concent_url;
            }
        }
    };


    let inital_confirm_headpdhones = {
        type: jsPsychHtmlButtonResponse,
        stimulus: '<h2> Are you using headphones right now? </h2>',
        choices: ['Yes', 'No'],
        button_html: ['<button class="jspsych-btn agreebutton">%choice%</button>', '<button class="jspsych-btn diagreebutton">%choice%</button>'],
        prompt: "",
        on_finish: function () {
            url = data_submit_url;
            data = jsPsych.data.get();
            data['trials'][data['trials'].length - 1]['date_time'] = new Date().toLocaleString();
            jsPsychSheet.uploadPartialData(url, data.csv())
            if (data['trials'][data['trials'].length - 1]['response'] == 1) {
                window.location.href = incompatible_device_url;
            }
        }
    };



    let confirm_headpdhones = {
        type: jsPsychHtmlButtonResponse,
        stimulus: '<h2> Were you wearing <b> headphones </b> for the <b>entire duration </b> of this test? </h2>',
        choices: ['Yes', 'No'],
        button_html: ['<button class="jspsych-btn agreebutton">%choice%</button>', '<button class="jspsych-btn diagreebutton">%choice%</button>'],
        prompt: "",
        on_finish: function () {
            url = data_submit_url;
            data = jsPsych.data.get();
            data['trials'][data['trials'].length - 1]['date_time'] = new Date().toLocaleString();
            jsPsychSheet.uploadPartialData(url, data.csv());
        }
    };

    // let hearing_impairment = {
    //     type: jsPsychHtmlButtonResponse,
    //     stimulus: '<h2> Do you have any known hearing impairments?</h2>',
    //     choices: ['Yes', 'No'],
    //     // button_html: ['<button class="jspsych-btn" style = "position: absolute; top: 60%; -ms-transform: translateY(-50%); left: 48%; transform: translateY(-50%);">%choice%</button>', '<button class="jspsych-btn" style = "position: absolute; top: 60%; -ms-transform: translateY(-50%); left: 52%; transform: translateY(-50%);">%choice%</button>'],
    //     prompt: "",
    //     on_finish: function () {
    //         url = data_submit_url;
    //         jsPsychSheet.uploadPartialData(url, jsPsych.data.get().csv())
    //     }
    // };

    // let feedback_for_test = {
    //     type: jsPsychSurveyHtmlForm,
    //     preamble: '<h1>What are your thoughts about the test?</h1>',
    //     html: '<p> <textarea id="test-resp-box" name="response" cols="100" rows="5"></textarea></p>',
    //     autofocus: 'test-resp-box',
    //     on_finish: function () {
    //         url = data_submit_url;
    //         jsPsychSheet.uploadPartialData(url, jsPsych.data.get().csv())
    //     }
    // };

    let browser_check = {
        type: jsPsychBrowserCheck,
        inclusion_function: (data) => {
            return data.mobile === false
        },
        exclusion_message: (data) => {
            if (data.mobile) {
                return '<p>You must use a desktop/laptop computer to participate in this experiment.</p>';
            }
        },
        on_finish: function () {
            url = data_submit_url;
            data = jsPsych.data.get();
            data['trials'][data['trials'].length - 1]['date_time'] = new Date().toLocaleString(); jsPsychSheet.uploadPartialData(url, data.csv())
            if (jsPsych.data.get()['trials'][0]['response'] == 1) {
                window.location.href = incompatible_device_url;
            }
        }
    };


    var timeline_all = [browser_check, instruction_screen, inital_confirm_headpdhones];
    timeline_all = timeline_all.concat(jsPsych.randomization.shuffle(timeline));
    timeline_all.splice(attn_1, 0, attn_1_block);
    timeline_all.splice(attn_2, 0, attn_2_block);
    timeline_all = timeline_all.concat([confirm_headpdhones, end_test]);

    jsPsych.run(timeline_all);
</script>

</html>